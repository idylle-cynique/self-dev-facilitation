#!/bin/bash

# === BRANCH_RESTRICTION_HOOK_START ===
# Pre-push hook with GitHub PR validation
# Restrictions:
# 1. Main branch: Always deny push
# 2. Other branches: Deny if PR exists AND ((no assignee OR assignee != self) OR (self is reviewer))

check_branch_restrictions() {
    local remote="$1"
    local url="$2"

# Configuration (prefer environment variables, fallback to git config or remote URL)
REPO_OWNER="${REPO_OWNER:-$(git config --get remote.origin.url | sed -n 's#.*github.com[:/]\([^/]*\)/.*#\1#p')}"
REPO_NAME="${REPO_NAME:-$(git config --get remote.origin.url | sed -n 's#.*github.com[:/][^/]*/\([^/.]*\).*#\1#p')}"
GITHUB_USER="${GITHUB_USER:-$(git config --get user.name)}"
GITHUB_EMAIL="${GITHUB_EMAIL:-$(git config --get user.email)}"

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to get PR info for a branch
get_pr_info() {
    local branch_name="$1"

    # Check if gh CLI is available
    if ! command -v gh >/dev/null 2>&1; then
        echo -e "${YELLOW}Warning: GitHub CLI (gh) not found. Skipping PR validation.${NC}" >&2
        return 1
    fi

    # Get PR information using GitHub CLI
    local pr_json=$(gh pr list --head "$branch_name" --json number,assignees,reviewRequests,state --repo "$REPO_OWNER/$REPO_NAME" 2>/dev/null)

    if [ -z "$pr_json" ] || [ "$pr_json" = "[]" ]; then
        # No PR exists for this branch
        return 1
    fi

    echo "$pr_json"
    return 0
}

# Function to check if user is assignee
is_self_assignee() {
    local pr_json="$1"
    local assignees=$(echo "$pr_json" | jq -r '.[0].assignees[]?.login // empty' 2>/dev/null)

    # If no assignees, return false (not self-assigned)
    if [ -z "$assignees" ]; then
        return 1
    fi

    # Check if current user is in assignees
    echo "$assignees" | grep -q "^$GITHUB_USER$"
}

# Function to check if user is reviewer
is_self_reviewer() {
    local pr_json="$1"
    local reviewers=$(echo "$pr_json" | jq -r '.[0].reviewRequests[]?.requestedReviewer?.login // empty' 2>/dev/null)

    # Check if current user is in requested reviewers
    echo "$reviewers" | grep -q "^$GITHUB_USER$"
}

# Function to get child branches (PRs that use current branch as base)
# Returns:
#   0: Child branches found (outputs PR list)
#   1: No child branches found
#   2: Required commands (gh/jq) not available
get_child_branches() {
    local branch_name="$1"

    # Check if gh CLI is available
    if ! command -v gh >/dev/null 2>&1; then
        echo "ERROR:gh_not_found" >&2
        return 2
    fi

    # Check if jq is available
    if ! command -v jq >/dev/null 2>&1; then
        echo "ERROR:jq_not_found" >&2
        return 2
    fi

    # Get all open PRs with base branch matching current branch
    local child_prs=$(gh pr list --state open --json number,headRefName,baseRefName --repo "$REPO_OWNER/$REPO_NAME" 2>/dev/null | \
        jq -r --arg base "$branch_name" '.[] | select(.baseRefName == $base) | "\(.number):\(.headRefName)"')

    if [ -z "$child_prs" ]; then
        return 1  # No child branches found
    fi

    echo "$child_prs"
    return 0  # Child branches found
}

# Function to check if push is a force-push (commit history modification)
# Returns: 0 (true) if force-push detected, 1 (false) otherwise
is_force_push() {
    local local_oid="$1"
    local remote_oid="$2"

    # New branch - not a force-push
    if [ "$remote_oid" = "0000000000000000000000000000000000000000" ]; then
        echo "New branch detected, skipping force-push check" >&2
        return 1  # false - not a force-push
    fi

    # Check if remote_oid is an ancestor of local_oid
    # If not, history has been rewritten (force-push)
    if ! git merge-base --is-ancestor "$remote_oid" "$local_oid" 2>/dev/null; then
        return 0  # true - force-push detected
    fi

    return 1  # false - not a force-push
}

# Main validation logic
# The following loop reads ref update information from stdin as provided by Git during a pre-push hook.
# Expected input: <local ref> <local sha1> <remote ref> <remote sha1> (one per line)
if [ -t 0 ]; then
    printf "${RED}エラー: 標準入力が検出されませんでした。このスクリプトはGit pre-pushフックとして実行される必要があります。${NC}\n" >&2
    exit 2
fi

while read local_ref local_oid remote_ref remote_oid; do
    # Skip if deleting branch
    if [ "$local_oid" = "0000000000000000000000000000000000000000" ]; then
        continue
    fi

    # Get branch name
    branch_name=$(echo "$remote_ref" | sed 's|refs/heads/||')

    echo "Checking push to branch: $branch_name" >&2

    # Detect force-push (commit history modification)
    force_push_detected=false
    if is_force_push "$local_oid" "$remote_oid"; then
        force_push_detected=true
        echo -e "${YELLOW}Warning: Force-push detected (commit history will be modified)${NC}" >&2
        echo -e "${YELLOW}Remote commit $remote_oid is not an ancestor of local commit $local_oid${NC}" >&2
    fi

    # If force-push detected, check for child branches
    if [ "$force_push_detected" = true ]; then
        echo "Force-push detected. Checking for child branches..." >&2

        child_branches=$(get_child_branches "$branch_name")
        check_result=$?

        # Case 1: Child branches found (return code 0)
        if [ $check_result -eq 0 ]; then
            echo -e "${RED}Error: Cannot force-push - child branches detected!${NC}" >&2
            echo -e "${RED}The following PRs are based on '$branch_name':${NC}" >&2
            echo "$child_branches" | while IFS=: read -r pr_num branch; do
                echo -e "${RED}  - PR #$pr_num: $branch${NC}" >&2
            done
            echo -e "${RED}Force-pushing would break these child branches.${NC}" >&2
            echo -e "${YELLOW}Please rebase child branches first, or use regular push.${NC}" >&2
            exit 1
        # Case 2: Command not available (return code 2)
        elif [ $check_result -eq 2 ]; then
            echo -e "${RED}Error: Cannot verify child branches - required commands not available${NC}" >&2
            echo -e "${RED}Force-push is blocked for safety reasons.${NC}" >&2
            echo -e "${YELLOW}Please install 'gh' (GitHub CLI) and 'jq' to enable force-push with child branch detection.${NC}" >&2
            echo -e "${YELLOW}Or contact your team lead if you need to force-push urgently.${NC}" >&2
            exit 1
        # Case 3: No child branches (return code 1)
        else
            echo "No child branches detected. Force-push allowed." >&2
        fi
    fi

    # Rule 1: Always deny push to main branch
    if [ "$branch_name" = "main" ]; then
        echo -e "${RED}Error: Direct push to main branch is not allowed${NC}" >&2
        echo -e "${RED}Please create a pull request instead${NC}" >&2
        exit 1
    fi

    # Rule 2: For other branches, check PR conditions
    pr_json=$(get_pr_info "$branch_name")

    if [ $? -eq 0 ]; then
        # PR exists for this branch
        echo "PR found for branch $branch_name, validating conditions..." >&2

        # Check condition: Assignee is not self or doesn't exist
        assignee_valid=false
        if is_self_assignee "$pr_json"; then
            assignee_valid=true
            echo "✓ Assignee check passed: You are assigned to this PR" >&2
        else
            echo "✗ Assignee check failed: You are not assigned to this PR (or no assignee set)" >&2
        fi

        # Check condition: Self is reviewer
        self_is_reviewer=false
        if is_self_reviewer "$pr_json"; then
            self_is_reviewer=true
            echo "✗ Reviewer check failed: You are assigned as reviewer" >&2
        else
            echo "✓ Reviewer check passed: You are not assigned as reviewer" >&2
        fi

        # Apply restriction logic:
        # Block if: (assignee != self OR no assignee) OR (self is reviewer)
        if [ "$assignee_valid" = false ] || [ "$self_is_reviewer" = true ]; then
            echo -e "${RED}Error: Push blocked due to PR validation rules:${NC}" >&2
            if [ "$assignee_valid" = false ] && [ "$self_is_reviewer" = true ]; then
                echo -e "${RED}  - You are not assigned to this PR AND you are a requested reviewer${NC}" >&2
            elif [ "$assignee_valid" = false ]; then
                echo -e "${RED}  - You are not assigned to this PR${NC}" >&2
            else
                echo -e "${RED}  - You are assigned as reviewer${NC}" >&2
            fi
            echo -e "${RED}  - Please assign yourself to the PR or remove yourself as reviewer${NC}" >&2
            exit 1
        fi

        echo "✓ PR validation passed for branch $branch_name" >&2
    else
        echo "No PR found for branch $branch_name, allowing push" >&2
    fi
done

echo "✓ All pre-push validations passed" >&2
exit 0

}
# === BRANCH_RESTRICTION_HOOK_END ===

# Call the main function
check_branch_restrictions "$@"